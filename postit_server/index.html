<html>
<head>
	<meta charset="utf-8">
	<title>Post It 2D</title>
	<!-- CSS stylesheet -->
	<link rel="stylesheet" type="text/css" href="./css/index.css">
	<link rel="stylesheet" type="text/css" href="./css/post_card.css">
	<!-- Google Maps API -->
	<script src="http://maps.google.com/maps/api/js?sensor=false"></script> 
	<!-- Load Global Variable -->
	<script src="./js/global.js"></script>
	<!-- Use Online Mode -->
	<script src="./js/online_post.js"></script>
	<!-- Basic functions -->
	<script src="./js/functions.js"></script>
	<!--  JQuery Library -->
	<script type="text/javascript" src="./js/jquery.js"></script>
	<!-- Local JavaScript -->
	<script src="./js/geolocation.js"></script>
	<!-- <script type="text/javascript" src="./js/offline_post.js"></script> -->
	<!-- nodejs use socketio to build server -->
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<div id="locationInfo">
		<div id="mapholder">Loading Map</div>
	</div>
	
	<div id="login">
		<div id="login1">
			<h2 >user name</h2>
			<input id="login_user_name">
			<h2 >password</h2>
			<input type="password" id="login_user_pwd">
		</div>
		<hr>
		<div id="login2">
			<button id="login2_button_login" onclick="user_login()"> Login </button>
			<button id="login2_button_signup" onclick="user_change_to_signup_page()"> Sign Up </button>
			<button id="login2_button_forgetpwd" > Forget Password? </button>
			<button id="login2_return_to_login" onclick="user_return_to_login()"> Return? </button>
		</div>

		<h1 id="login_head"> 
			Welcome to PostIt! 
		</h1>
	</div>

	<button id="friend_list" onclick="show_friend_list()"> Friend List </button>

	<div id="friend_list_panel">
		<div id="user_profile_picture"> 
		</div>
		<h2 id="friend_list_user_name">
			User Name
		</h2>
		<button id="add_friend" onclick="add_friend()">Add Friend</button>
		<button id="logout">Logout</button>
		<div id="friend_information">
			<ul id="friend_information_list">
			</ul>
		</div>
	</div>

	<button id="notifications" onclick="show_notifications_panel()"> Notifications </button>
	<div id="notifications_panel">
		<h1 style="margin-left:20px;">
			Notifications ;)
		</h1>
		<div id="notifications_area">
			<ul id="notifications_list">
				
			</ul>
		</div>
	</div>
	<script>
	// login function
	var user_login = function()
	{
		if(!CONNECTED_TO_SERVER)
		{
			alert("Cannot connect to server")
			return;
		}
		alert("login")
		var user_name = $("#login_user_name").val();
		var pwd = $("#login_user_pwd").val();
		socket.emit("user_login", [user_name, pwd]);
	}


	// signup function
	var user_signup = function()
	{
		if(!CONNECTED_TO_SERVER)
		{
			alert("Cannot connect to server")
			return;
		}
		var user_name = $("#login_user_name").val();
		var user_pwd = $("#login_user_pwd").val();
		// check whether user name is valid
		if(user_name.length === 0)
		{
			alert("Invalid user name: "+user_name);
			return ;
		}
		if(CONNECTED_TO_SERVER)
		{
			/* check with server whether user existed */
			socket.emit("user_wants_to_signup", [user_name, user_pwd])
		}
		else
		{
			alert("U haven't connected to server; please check ur internet connection")
		}
	}

	var user_change_to_signup_page = function()
	{
		// hide login2_button_login and login2_button_forgetpwd
		// var login2_button_login_x = $("#login2_button_login").offset().left;
		// $("#login2_button_login").animate({"display":"none"}, 1000);
		$("#login2_button_login").hide(1000);
		$("#login2_button_forgetpwd").hide(1000);
		$("#login2_return_to_login").show(1000);
		document.getElementById("login2_button_signup").onclick = user_signup
		document.getElementById("login2_button_signup").innerText = "Create Account"
	}

	var user_return_to_login = function()
	{
		$("#login2_button_login").show(1000);
		$("#login2_button_forgetpwd").show(1000);
		$("#login2_return_to_login").hide(1000);
		document.getElementById("login2_button_signup").onclick = user_change_to_signup_page
		document.getElementById("login2_button_signup").innerText = "Sign Up"
	}

	/* show friend list panel */
	var show_friend_list = function()
	{
		$("#friend_list_panel").show(1000);
		document.getElementById("friend_list").onclick = hide_friend_list_panel; // reset click function
		$("#friend_list_user_name").html ( CURRENT_USER_NAME );
		socket.emit("request_friend_list_information", CURRENT_USER_NAME);
		socket.on("receive_friend_list_information", function(data)
		{
			var FRIEND_LIST = data;
			// check friend list
			// console.log(FRIEND_LIST);

			var content = "";
			for(var i = 0; i < FRIEND_LIST.length; i++)
			{
				var user_name = FRIEND_LIST[i];
				var user_name_content = "<p>"+user_name+"</p>";
				var l = "<li>"+user_name+"</li>";
				content += l;
			}

			document.getElementById('friend_information_list').innerHTML = content;
		})
	}
	/* hide friend list panel */
	var hide_friend_list_panel = function()
	{
		$("#friend_list_panel").hide(1000);
		document.getElementById("friend_list").onclick = show_friend_list;
	}

	/* show notification panel */
	var show_notifications_panel = function()
	{
		$("#notifications_panel").show(1000);
		document.getElementById("notifications").onclick = hide_notification_panel;
		
		socket.emit("request_notifications_information", CURRENT_USER_NAME);
		socket.on("receive_notifications_information", function(data)
		{
			FRIENDS_REQUEST = data;
			// check friend list
			console.log(FRIENDS_REQUEST);
			var content = "";
			for(var i = 0; i < FRIENDS_REQUEST.length; i++)
			{
				var user_name = FRIENDS_REQUEST[i];
				var user_name_content = "<p>"+user_name+"</p>";
				var user_accept_button = "<button onclick=\"accept_friend('" + user_name + "')\">accpet</button>";
				var user_reject_button = "<button onclick=\"reject_friend('" + user_name + "')\">reject</button>";
				var l = "<li>"+user_name_content+user_accept_button+user_reject_button+"</li>"
				content += l;
			}
			// add content to ul
			document.getElementById('notifications_list').innerHTML = content;
		})
	}
	/* hide notification panel */
	var hide_notification_panel = function()
	{
		$("#notifications_panel").hide(1000);
		document.getElementById("notifications").onclick = show_notifications_panel;
	}
	var accept_friend = function(user_name) // accpet user friend request from user_name
	{
		alert("Accept Friend: "+user_name);
		socket.emit("accept_friend", [CURRENT_USER_NAME, user_name]);
	}
	var reject_friend = function(user_name) // accpet user friend request from user_name
	{
		alert("Reject Friend: "+user_name)
		socket.emit("reject_friend", [CURRENT_USER_NAME, user_name]);
	}

	/* add friend */
	var add_friend = function()
	{
		var find_friend_name = prompt("Find Friend Name: ");
		socket.emit("find_friend_name", [find_friend_name, CURRENT_USER_NAME]);
	}

	window.onload = function(){ // window onload
		alert("Onload")
		$("#login").animate({ "top": 0 }, 1000); 

		socket = io.connect();
		socket.on('connect_to_server$', function (data) {
			console.log("CONNECT TO SERVER") // connect to server successfully;
			CONNECTED_TO_SERVER = true; 
		});

		var updateMap = function(data){ // update map data
			var latitude = data['latitude']
			var longitude = data['longitude']
			var message = data['message']
			var user_name = data['user_name']
			var post_date = data['time']
			var comment = data['comment']
			var inforindow_marker_count = data['inforindow_marker_count']
				  			// get icon from google
				  			var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
			// init latlon
			var latlon=new google.maps.LatLng(latitude, longitude)
			// set marker
			var marker=new google.maps.Marker({position:latlon,
				map:Google_Map,
											   icon:iconBase + 'schools_maps.png', // set icon
											   title:user_name+":"+post_date}); 

			var infowindow = new google.maps.InfoWindow();
			INFOWINDOWS[inforindow_marker_count] = infowindow
			MARKERS[inforindow_marker_count] = marker

			// init info window
			google.maps.event.addListener(marker, 'click', function() {
	            //                        alert(user_name + ": "+information[user_name][post_date]["message"])
	            //infowindow.setContent("<strong>"+user_name+":</strong></br>"+message)
	            infowindow.setContent("Loading...")
	            socket.emit('requirePostContent',[user_name, post_date])
	            infowindow.open(Google_Map, marker)                
	        });
		}

		   // update map from server
		   socket.on('updateMapForFirstTimeConnectedUser',function(data){
		   console.log("Begin to receive data from server")
		   	for (var user_name in data){
		   		for(var post_date in data[user_name]){
		   			var data_ = data[user_name][post_date]
		   			updateMap(data_)
		   		}
		   	}
		   })
			// post comment 						
			var postComment = function(
								       host_user_name,   // get host user name
								       host_user_post_date, // get host user post date
								       infowindow_id // get current inforwindow_id
								       )  
			{
				//console.log("POSTCOMMENT")

				var comment_message = document.getElementById(infowindow_id).value
				socket.emit("OtherUserComment", [ host_user_name,
												  user_name, // comment user name
												  host_user_post_date,
												  comment_message,
												  infowindow_id
												  ]  )
			}

			// update comment
			socket.on('Update_InfoWindow_Information_From_User_Comment',function(data){
				console.log("UPDATE USER COMMENT")
				var content = formatContent(data['user_name'],data['message'],data['time'],data['comment'],data['inforindow_marker_count'])
				INFOWINDOWS[data['inforindow_marker_count']].setContent( content )
			})

		  // update map after other people post or self post
		  socket.on('Update_Map',function(data){
		  	console.log("UPDATE MAP")
		  	//console.log(data)
		  	var latitude = data['latitude']
		  	var longitude = data['longitude']
		  	var message = data['message']
		  	var user_name = data['user_name']
		  	var post_date = data['time']
		  	var comment = data['comment']
		  	var inforindow_marker_count = data['inforindow_marker_count']

		  	User_Location_Marker_InfoWindow.setContent("<p>Successfully PostIt !</p>")

  			// get icon from google
  			var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
			// init latlon
			var latlon=new google.maps.LatLng(latitude, longitude)
			// set marker
			var marker=new google.maps.Marker({position:latlon,
				map:Google_Map,
											   icon:iconBase + 'schools_maps.png', // set icon
											   title:user_name+":"+post_date}); 

			var infowindow = new google.maps.InfoWindow();
			INFOWINDOWS[inforindow_marker_count] = infowindow
			MARKERS[inforindow_marker_count] = marker

			// init info window
			google.maps.event.addListener(marker, 'click', function() {
	            //                        alert(user_name + ": "+information[user_name][post_date]["message"])
	            //infowindow.setContent("<strong>"+user_name+":</strong></br>"+message)
	            infowindow.setContent("Loading...")
	            socket.emit('requirePostContent',[user_name, post_date])
	            infowindow.open(Google_Map, marker)                
	        });
		})
		// format content in inforwindows
		var formatContent = function(host_user_name, host_user_message, post_date,  comment_obj, inforindow_marker_count){
			var output = ["<strong>"+host_user_name+":</strong></br>"+host_user_message+"</br></br>--------</br><strong>Comment:</strong></br>" ]
			var i = 0
			while(i<comment_obj.length){
				var comment_user_name = comment_obj[i]["comment_user_name"]
				var comment_message = comment_obj[i]["comment_message"]
				output.push("<bold>"+comment_user_name+":</bold>")
				output.push(comment_message+"</br>")
				i++
			}
			output.push("</br>--------</br>")
			output.push("<input id='"+inforindow_marker_count+"' onclick=\'this.value=\"\"\' value='leave comment'/>")
			output.push("<button onclick=\"postComment('"+host_user_name+"','"+post_date+ "'," +inforindow_marker_count+ ")\">post</button>"  // post comment
				)
			return convertArrayToString(output)
		}

		// receive data from server to check posted information and other people's comment
		socket.on('sendPostContent',function(data){
			var host_user_name = data['user_name']
			var inforindow_marker_count = data['inforindow_marker_count']
			var message = data['message']
			var comment_obj = data['comment']
			
			var content = formatContent(host_user_name, message, data['time'], comment_obj, inforindow_marker_count)
			//INFOWINDOWS[infowindow_id].setContent( "<strong>"+host_user_name+":</strong></br>"+message )
			INFOWINDOWS[inforindow_marker_count].setContent( content )
		})
		// user already registered
		socket.on('user_already_registered', function(data)
		{
			alert("User: "+data[0]+" already registered... Please changed a name");
		})

		// user_successfully_registered
		socket.on('user_successfully_registered', function(data)
		{
			alert("Successfully Sign Up!!! ;)");
			USER_LOGIN = true; // update global variable
			CURRENT_USER_NAME = data; // update user_name

			// hide login page
			$("#login").animate({ "top": -800 }, 1000); 
			// show friend list button
			$("#friend_list").show(1000);
			// show notification button
			$("#notifications").show(1000);

		})

		// login--wrong_user_name
		socket.on('login--wrong_user_name_or_wrong_password', function(data)
		{
			alert(data);
		})

		socket.on('successfully-login', function(data)
		{
			alert("Successfully Login");
			CURRENT_USER_NAME = data[0]; // update user_name
			FRIENDS_REQUEST = data[1];   // update user friend list
			USER_LOGIN = true; // update global variable
			// hide login page
			$("#login").animate({ "top": -800 }, 1000); 
			// show friend list button
			$("#friend_list").show(1000);
			// show notification button
			$("#notifications").show(1000);
			// upload ur location to ur friend!
    		socket.emit("send_ur_location_to_friend", [CURRENT_USER_NAME, longitude, latitude]);
		})

		// user_does_not_exist
		socket.on('user_does_not_exist', function(data)
		{
			alert("User Doesn't Exist");
		})

		// have friend request
		socket.on('have_friend_request', function(data)
		{
			from_user_name = data[0];  // get request from user
			FRIENDS_REQUEST = data[1]; // update friend request data
			alert("You have a friend request from : " + from_user_name);
		})

		// update friend location 
		socket.on("update_friend_location", function(data)
		{
			var longitude = data[0];
			var latitude = data[1];
			var user_name = data[2];

			console.log("GET longitude: "+longitude+" latitude: "+latitude+" from "+user_name);
				// get icon from google
  			var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
			// init latlon
			var latlon=new google.maps.LatLng(latitude, longitude)
			// set marker
			var marker=new google.maps.Marker({position:latlon,
				map:Google_Map,
				icon:iconBase + 'schools_maps.png', // set icon
				title:user_name}); 
		})

		// is already
		socket.on("is_already_friend", function(data){
			alert(data+ " is already ur friend");
		})
	}
	</script>

</body>
</html>



















