<html>
<head>
	<meta charset="utf-8">
	<title>Post It 2D</title>
	<!-- CSS stylesheet -->
	<link rel="stylesheet" type="text/css" href="./css/index.css">
	<link rel="stylesheet" type="text/css" href="./css/post_card.css">
	<!-- Google Maps API -->
	<script src="http://maps.google.com/maps/api/js?sensor=false"></script> 
	<!-- Local JavaScript -->
	<script src="./js/geolocation.js"></script>
	<!-- Use Online Mode -->
	<script src="./js/online_post.js"></script>
	<!-- Basic functions -->
	<script src="./js/functions.js"></script>

	<!-- <script type="text/javascript" src="./js/offline_post.js"></script> -->
	<!-- nodejs use socketio to build server -->
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<div id="locationInfo">
		<div id="mapholder">I am mapholder</div>
	</div>

	<script>
	var socket = io.connect();
	socket.on('news', function (data) {
		console.log(data);
		socket.emit('my other event', { my: 'data' });
	});


		  var updateMap = function(data){ // update map data
		  	var latitude = data['latitude']
		  	var longitude = data['longitude']
		  	var message = data['message']
		  	var user_name = data['user_name']
		  	var post_date = data['time']
		  	var comment = data['comment']
		  	var inforindow_marker_count = data['inforindow_marker_count']
				  			// get icon from google
				  			var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
			// init latlon
			var latlon=new google.maps.LatLng(latitude, longitude)
			// set marker
			var marker=new google.maps.Marker({position:latlon,
				map:Google_Map,
											   icon:iconBase + 'schools_maps.png', // set icon
											   title:user_name+":"+post_date}); 

			var infowindow = new google.maps.InfoWindow();
			INFOWINDOWS[inforindow_marker_count] = infowindow
			MARKERS[inforindow_marker_count] = marker

			// init info window
			google.maps.event.addListener(marker, 'click', function() {
	            //                        alert(user_name + ": "+information[user_name][post_date]["message"])
	            //infowindow.setContent("<strong>"+user_name+":</strong></br>"+message)
	            infowindow.setContent("Loading...")
	            socket.emit('requirePostContent',[user_name, post_date])
	            infowindow.open(Google_Map, marker)                
	        });
		}

		   // update map from server
		   socket.on('updateMapForFirstTimeConnectedUser',function(data){
		   	console.log("Begin to receive data from server")
		   	for (var user_name in data){
		   		for(var post_date in data[user_name]){
		   			var data_ = data[user_name][post_date]
		   			updateMap(data_)
		   		}
		   	}
		   })
			// post comment 						
			var postComment = function(
								       host_user_name,   // get host user name
								       host_user_post_date, // get host user post date
								       infowindow_id // get current inforwindow_id
								       )  
			{
				//console.log("POSTCOMMENT")

				var comment_message = document.getElementById(infowindow_id).value
				socket.emit("OtherUserComment", [ host_user_name,
												  user_name, // comment user name
												  host_user_post_date,
												  comment_message,
												  infowindow_id
												  ]  )
			}

			// update comment
			socket.on('Update_InfoWindow_Information_From_User_Comment',function(data){
				console.log("UPDATE USER COMMENT")
				var content = formatContent(data['user_name'],data['message'],data['time'],data['comment'],data['inforindow_marker_count'])
				INFOWINDOWS[data['inforindow_marker_count']].setContent( content )
			})

		  // update map after other people post or self post
		  socket.on('Update_Map',function(data){
		  	console.log("UPDATE MAP")
		  	//console.log(data)
		  	var latitude = data['latitude']
		  	var longitude = data['longitude']
		  	var message = data['message']
		  	var user_name = data['user_name']
		  	var post_date = data['time']
		  	var comment = data['comment']
		  	var inforindow_marker_count = data['inforindow_marker_count']

		  	User_Location_Marker_InfoWindow.setContent("<p>Successfully PostIt !</p>")

				  			// get icon from google
				  			var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
			// init latlon
			var latlon=new google.maps.LatLng(latitude, longitude)
			// set marker
			var marker=new google.maps.Marker({position:latlon,
				map:Google_Map,
											   icon:iconBase + 'schools_maps.png', // set icon
											   title:user_name+":"+post_date}); 

			var infowindow = new google.maps.InfoWindow();
			INFOWINDOWS[inforindow_marker_count] = infowindow
			MARKERS[inforindow_marker_count] = marker

			// init info window
			google.maps.event.addListener(marker, 'click', function() {
	            //                        alert(user_name + ": "+information[user_name][post_date]["message"])
	            //infowindow.setContent("<strong>"+user_name+":</strong></br>"+message)
	            infowindow.setContent("Loading...")
	            socket.emit('requirePostContent',[user_name, post_date])
	            infowindow.open(Google_Map, marker)                
	        });
		})
		// format content in inforwindows
		var formatContent = function(host_user_name, host_user_message, post_date,  comment_obj, inforindow_marker_count){
			var output = ["<strong>"+host_user_name+":</strong></br>"+host_user_message+"</br></br>--------</br><strong>Comment:</strong></br>" ]
			var i = 0
			while(i<comment_obj.length){
				var comment_user_name = comment_obj[i]["comment_user_name"]
				var comment_message = comment_obj[i]["comment_message"]
				output.push("<bold>"+comment_user_name+":</bold>")
				output.push(comment_message+"</br>")
				i++
			}
			output.push("</br>--------</br>")
			output.push("<input id='"+inforindow_marker_count+"' onclick=\'this.value=\"\"\' value='leave comment'/>")
			output.push("<button onclick=\"postComment('"+host_user_name+"','"+post_date+ "'," +inforindow_marker_count+ ")\">post</button>"  // post comment
				)
			return convertArrayToString(output)
		}

		// receive data from server to check posted information and other people's comment
		socket.on('sendPostContent',function(data){
			var host_user_name = data['user_name']
			var inforindow_marker_count = data['inforindow_marker_count']
			var message = data['message']
			var comment_obj = data['comment']
			
			var content = formatContent(host_user_name, message, data['time'], comment_obj, inforindow_marker_count)
			//INFOWINDOWS[infowindow_id].setContent( "<strong>"+host_user_name+":</strong></br>"+message )
			INFOWINDOWS[inforindow_marker_count].setContent( content )
		})
		</script>

	</body>
	</html>